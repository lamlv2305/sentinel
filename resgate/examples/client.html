<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ResGate SSE Client</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .controls {
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 4px;
      }
      .controls input,
      .controls select,
      .controls button {
        margin: 5px;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      .controls button {
        background: #007bff;
        color: white;
        cursor: pointer;
      }
      .controls button:hover {
        background: #0056b3;
      }
      .controls button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        font-weight: bold;
      }
      .status.connected {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status.disconnected {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .status.connecting {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }
      .events {
        height: 400px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 10px;
        background: #f8f9fa;
        font-family: monospace;
        font-size: 12px;
      }
      .event {
        margin: 5px 0;
        padding: 8px;
        border-left: 3px solid #007bff;
        background: white;
        border-radius: 3px;
      }
      .event-header {
        font-weight: bold;
        color: #007bff;
        margin-bottom: 4px;
      }
      .event-data {
        color: #333;
        white-space: pre-wrap;
      }
      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
        margin: 15px 0;
      }
      .stat-card {
        padding: 15px;
        background: #e9ecef;
        border-radius: 4px;
        text-align: center;
      }
      .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #007bff;
      }
      .stat-label {
        font-size: 12px;
        color: #6c757d;
        margin-top: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ResGate SSE Client</h1>

      <div class="controls">
        <input
          type="text"
          id="serverUrl"
          value="http://localhost:9005/sse"
          placeholder="SSE Endpoint URL"
        />
        <input
          type="text"
          id="apikey"
          value="sample-api-key-12345"
          placeholder="API Key"
        />
        <select id="project">
          <option value="project-alpha">Project Alpha</option>
          <option value="project-beta">Project Beta</option>
          <option value="project-gamma">Project Gamma</option>
        </select>
        <button id="connectBtn" onclick="connect()">Connect</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled>
          Disconnect
        </button>
        <button onclick="clearEvents()">Clear Events</button>
      </div>

      <div id="status" class="status disconnected">Disconnected</div>

      <div class="stats">
        <div class="stat-card">
          <div id="eventCount" class="stat-value">0</div>
          <div class="stat-label">Events Received</div>
        </div>
        <div class="stat-card">
          <div id="connectionTime" class="stat-value">--</div>
          <div class="stat-label">Connected Time</div>
        </div>
        <div class="stat-card">
          <div id="lastEventTime" class="stat-value">--</div>
          <div class="stat-label">Last Event</div>
        </div>
      </div>

      <h3>Events Log</h3>
      <div id="events" class="events"></div>
    </div>

    <script>
      let eventSource = null;
      let eventCount = 0;
      let connectionStartTime = null;
      let connectionTimer = null;

      function updateStatus(status, message) {
        const statusEl = document.getElementById("status");
        statusEl.className = `status ${status}`;
        statusEl.textContent = message;
      }

      function updateStats() {
        document.getElementById("eventCount").textContent = eventCount;

        if (connectionStartTime) {
          const elapsed = Math.floor((Date.now() - connectionStartTime) / 1000);
          const minutes = Math.floor(elapsed / 60);
          const seconds = elapsed % 60;
          document.getElementById(
            "connectionTime"
          ).textContent = `${minutes}:${seconds.toString().padStart(2, "0")}`;
        }
      }

      function addEvent(type, data) {
        const eventsContainer = document.getElementById("events");
        const eventEl = document.createElement("div");
        eventEl.className = "event";

        const headerEl = document.createElement("div");
        headerEl.className = "event-header";
        headerEl.textContent = `[${new Date().toLocaleTimeString()}] ${type}`;

        const dataEl = document.createElement("div");
        dataEl.className = "event-data";
        dataEl.textContent = data;

        eventEl.appendChild(headerEl);
        eventEl.appendChild(dataEl);
        eventsContainer.appendChild(eventEl);
        eventsContainer.scrollTop = eventsContainer.scrollHeight;

        if (type !== "System") {
          eventCount++;
          document.getElementById("lastEventTime").textContent =
            new Date().toLocaleTimeString();
          updateStats();
        }
      }

      function connect() {
        if (eventSource) {
          disconnect();
        }

        const serverUrl = document.getElementById("serverUrl").value;
        const apikey = document.getElementById("apikey").value;
        const project = document.getElementById("project").value;

        const url = `${serverUrl}?apikey=${encodeURIComponent(
          apikey
        )}&project=${encodeURIComponent(project)}`;

        updateStatus("connecting", "Connecting...");
        addEvent("System", `Connecting to: ${url}`);

        eventSource = new EventSource(url);
        connectionStartTime = Date.now();

        eventSource.onopen = function (event) {
          updateStatus("connected", `Connected to ${project}`);
          addEvent("System", "Connection established");
          document.getElementById("connectBtn").disabled = true;
          document.getElementById("disconnectBtn").disabled = false;

          // Start connection timer
          connectionTimer = setInterval(updateStats, 1000);
        };

        eventSource.onmessage = function (event) {
          try {
            // Try to decode base64 data
            let data = event.data;
            if (data.startsWith("data: ")) {
              data = data.substring(6);
            }

            try {
              const decoded = atob(data);
              const parsed = JSON.parse(decoded);
              addEvent("Resource Change", JSON.stringify(parsed, null, 2));
            } catch (e) {
              // If not base64 or JSON, show raw data
              addEvent("Message", data);
            }
          } catch (e) {
            addEvent("Raw Data", event.data);
          }
        };

        eventSource.onerror = function (event) {
          console.error("SSE Error:", event);
          addEvent("System", "Connection error occurred");

          if (eventSource.readyState === EventSource.CLOSED) {
            updateStatus("disconnected", "Connection closed");
            document.getElementById("connectBtn").disabled = false;
            document.getElementById("disconnectBtn").disabled = true;

            if (connectionTimer) {
              clearInterval(connectionTimer);
              connectionTimer = null;
            }
          }
        };

        // Handle specific event types
        eventSource.addEventListener("connected", function (event) {
          addEvent("Connected", event.data);
        });
      }

      function disconnect() {
        if (eventSource) {
          eventSource.close();
          eventSource = null;
        }

        updateStatus("disconnected", "Disconnected");
        addEvent("System", "Disconnected by user");
        document.getElementById("connectBtn").disabled = false;
        document.getElementById("disconnectBtn").disabled = true;

        if (connectionTimer) {
          clearInterval(connectionTimer);
          connectionTimer = null;
        }

        connectionStartTime = null;
        document.getElementById("connectionTime").textContent = "--";
      }

      function clearEvents() {
        document.getElementById("events").innerHTML = "";
        eventCount = 0;
        document.getElementById("lastEventTime").textContent = "--";
        updateStats();
      }

      // Initialize stats
      updateStats();
    </script>
  </body>
</html>
